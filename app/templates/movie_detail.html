{% set title = (item.title or "Movie") ~ " – Arctic" %}
{% include "partials/_header.html" %}

<div class="page movie-detail">

    <!-- Hero -->
    <div class="hero" style="--bg:url('{{ (item.extra_json or {}).get('backdrop') or (item.backdrop_url or '') }}')">
        <div class="poster">
            <img src="{{ (item.extra_json or {}).get('poster') or item.poster_url or '/static/img/placeholder.png' }}"
                alt="{{ item.title }}">
        </div>
        <div class="meta">
            <h1 class="title">{{ item.title }}
                {% if item.year %}<span class="year">({{ item.year }})</span>{% endif %}
            </h1>
            {% set ej = item.extra_json or {} %}
            {% if ej.get('tagline') %}<div class="tagline">{{ ej['tagline'] }}</div>{% endif %}
            {% if ej.get('genres') %}
            <div class="genres">{{ ", ".join(ej['genres']) }}</div>
            {% endif %}
            <div class="actions">
                {% if files %}
                <button id="playBtn" class="btn primary" data-file="{{ files[0].id }}">▶ Play</button>
                {% endif %}
                <a class="btn" href="/movies">Back to Movies</a>
            </div>
        </div>
    </div>

    <!-- Collapsible player (stays on this page) -->
    {% if files %}
    <section class="player-wrap collapsed" id="playerWrap">
        <div class="player-bar">
            <div class="left">
                <strong>Now Playing:</strong> {{ item.title }}
            </div>
            <div class="right">
                <select id="sourceSelect" class="select">
                    {% for f in files %}
                    <option value="/stream/{{ f.id }}/file" data-file="{{ f.id }}">
                        {{ f.path.split('/')[-1].split('\\')[-1] }}
                    </option>
                    {% endfor %}
                </select>
                <button id="minBtn" class="btn small" title="Minimize">–</button>
                <button id="closeBtn" class="btn small" title="Close">✕</button>
            </div>
        </div>

        <div class="player-area">
            <video id="plyr" playsinline controls preload="metadata"
                poster="{{ ej.get('poster') or item.poster_url or '/static/img/placeholder.png' }}">
                <!-- src set by JS -->
            </video>
        </div>
    </section>
    {% endif %}

    <!-- Overview -->
    {% if ej.get('overview') %}
    <section class="panel">
        <h2>Overview</h2>
        <p>{{ ej['overview'] }}</p>
    </section>
    {% endif %}

    <!-- Cast (horizontal scroll) -->
    {% if ej.get('cast') %}
    <section class="panel">
        <div class="panel-head">
            <h2>Cast</h2>
        </div>
        <div class="cast-strip" id="castStrip">
            {% for c in ej['cast'] %}
            <div class="cast-card">
                <img src="{{ c.get('profile') or '/static/img/placeholder.png' }}" alt="{{ c.get('name') }}">
                <div class="name">{{ c.get('name') }}</div>
                {% if c.get('character') %}<div class="role">{{ c.get('character') }}</div>{% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

</div>

<!-- Plyr assets (CDN). If your CSP is strict, allow cdn.plyr.io in script-src & style-src OR host these files locally. -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js" nonce="{{ request.state.csp_nonce }}"></script>

<script nonce="{{ request.state.csp_nonce }}">
    (function () {
        const wrap = document.getElementById('playerWrap');
        const playBtn = document.getElementById('playBtn');
        const minBtn = document.getElementById('minBtn');
        const closeBtn = document.getElementById('closeBtn');
        const sourceSelect = document.getElementById('sourceSelect');

        if (!wrap || !playBtn) return;

        // init Plyr
        const video = document.getElementById('plyr');
        const player = new Plyr(video, {
            ratio: '16:9',
            clickToPlay: true,
            seekTime: 10,
            keyboard: { focused: true, global: true }
        });

        // resume position per-file
        const posKey = (fid) => `ams:pos:${fid}`;
        function loadSource(url, fileId, autoplay = true) {
            // set video source
            player.source = {
                type: 'video',
                sources: [{ src: url, type: 'video/mp4' }], // browser will still try other containers via sniffing
            };
            video.dataset.fileId = fileId;

            // resume time if available
            try {
                const last = parseFloat(localStorage.getItem(posKey(fileId)) || 'NaN');
                if (!Number.isNaN(last) && last > 1) {
                    player.once('canplay', () => { player.currentTime = last; if (autoplay) player.play(); });
                } else if (autoplay) {
                    player.once('canplay', () => player.play());
                }
            } catch {
                if (autoplay) player.once('canplay', () => player.play());
            }
        }

        // open player
        function openPlayer() {
            wrap.classList.remove('collapsed');
            wrap.classList.add('expanded');
        }
        // minimize to small floating bar
        function minimizePlayer() {
            wrap.classList.remove('expanded');
            wrap.classList.add('mini');
        }
        // close player
        function closePlayer() {
            try { player.pause(); } catch { }
            wrap.classList.add('collapsed');
            wrap.classList.remove('expanded', 'mini');
        }

        // wire buttons
        playBtn.addEventListener('click', () => {
            const fileId = playBtn.dataset.file;
            const url = `/stream/${fileId}/file`;
            // update select to the file
            [...sourceSelect.options].forEach(o => {
                o.selected = (o.dataset.file === fileId);
            });
            loadSource(url, fileId, true);
            openPlayer();
        });

        minBtn?.addEventListener('click', () => {
            if (wrap.classList.contains('mini')) openPlayer(); else minimizePlayer();
        });
        closeBtn?.addEventListener('click', closePlayer);

        sourceSelect?.addEventListener('change', () => {
            const opt = sourceSelect.options[sourceSelect.selectedIndex];
            loadSource(opt.value, opt.dataset.file, true);
        });

        // persist position every 3s
        let tLast = 0;
        player.on('timeupdate', () => {
            const fid = video.dataset.fileId;
            if (!fid) return;
            const now = performance.now();
            if (now - tLast > 3000) {
                tLast = now;
                try { localStorage.setItem(posKey(fid), String(player.currentTime)); } catch { }
            }
        });
        player.on('ended', () => {
            const fid = video.dataset.fileId;
            try { localStorage.removeItem(posKey(fid)); } catch { }
        });
    })();
</script>

<style>
    /* ---- Detail layout ---- */
    .movie-detail .hero {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 22px;
        padding: 20px;
        border-radius: 16px;
        background:
            linear-gradient(to bottom, rgba(0, 0, 0, .45), rgba(0, 0, 0, .65)),
            var(--bg) center/cover no-repeat;
    }

    .movie-detail .poster img {
        width: 220px;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, .4);
    }

    .movie-detail .meta .title {
        font-size: 28px;
        margin: 0 0 6px;
    }

    .movie-detail .meta .year {
        color: var(--muted);
        font-weight: 400;
    }

    .movie-detail .tagline {
        color: var(--muted);
        margin-bottom: 6px;
        font-style: italic;
    }

    .movie-detail .genres {
        color: var(--muted-2);
        margin-bottom: 12px;
    }

    .movie-detail .actions .btn {
        margin-right: 8px;
    }

    /* ---- Player panel ---- */
    .player-wrap {
        margin: 18px 0;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 14px;
        overflow: hidden;
        background: #0e0e0f;
        display: none;
    }

    .player-wrap.expanded,
    .player-wrap.mini {
        display: block;
    }

    .player-wrap .player-bar {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        padding: 8px 10px;
        background: #141418;
        border-bottom: 1px solid rgba(255, 255, 255, .06);
    }

    .player-wrap .player-bar .right {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .player-wrap .player-area {
        padding: 10px;
    }

    .player-wrap .player-area video {
        width: 100%;
        border-radius: 10px;
        background: #000;
    }

    /* minimized floating style */
    .player-wrap.mini {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 360px;
        max-width: 45vw;
        z-index: 50;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .5);
    }

    .player-wrap.mini .player-area video {
        height: 200px;
        object-fit: cover;
    }

    /* collapsed (hidden) */
    .player-wrap.collapsed {
        display: none;
    }

    /* ---- Cast strip ---- */
    .cast-strip {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 4px;
        scroll-snap-type: x mandatory;
    }

    .cast-strip::-webkit-scrollbar {
        height: 8px;
    }

    .cast-card {
        flex: 0 0 auto;
        width: 110px;
        scroll-snap-align: start;
        text-align: center;
    }

    .cast-card img {
        width: 110px;
        height: 165px;
        object-fit: cover;
        border-radius: 10px;
        background: #222;
        box-shadow: 0 6px 14px rgba(0, 0, 0, .35);
    }

    .cast-card .name {
        margin-top: 6px;
        font-size: 13px;
        line-height: 1.2
    }

    .cast-card .role {
        color: var(--muted);
        font-size: 12px;
    }

    /* small helpers */
    .select {
        background: #18181d;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, .1);
        border-radius: 8px;
        padding: 6px 8px;
    }

    .btn.small {
        padding: 4px 8px;
        font-size: 12px;
    }

    .btn.primary {
        background: var(--brand);
        color: #fff;
    }
</style>

{% include "partials/_footer.html" %}