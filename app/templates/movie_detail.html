{% extends "base.html" %}
{% block title %}{{ (item.title or "Movie") ~ " – Arctic" }}{% endblock %}

{% block content %}
{% set ej = item.extra_json or {} %}
{% set poster = ej.get('poster') or item.poster_url or '/static/img/placeholder.png' %}
{% set backdrop = ej.get('backdrop') or item.backdrop_url or '' %}

<div class="page movie-detail">
    <!-- Hero -->
    <div class="hero" style="--bg:url('{{ backdrop }}')">
        <div class="poster"><img src="{{ poster }}" alt="{{ item.title }}"></div>
        <div class="meta">
            <h1 class="title">
                {{ item.title }}{% if item.year %}<span class="year"> ({{ item.year }})</span>{% endif %}
            </h1>
            {% if ej.get('tagline') %}<div class="tagline">{{ ej['tagline'] }}</div>{% endif %}
            {% if ej.get('genres') %}<div class="genres">{{ ", ".join(ej['genres']) }}</div>{% endif %}
            <div class="actions">
                {% if files %}
                <button id="playBtn" class="btn primary" data-file-id="{{ files[0].id }}" data-item-id="{{ item.id }}"
                    data-title="{{ item.title|e }}">▶ Play</button>
                {% endif %}
                <a class="btn" href="/movies">Back to Movies</a>
            </div>
        </div>
    </div>

    {% if files %}
    <section class="player-wrap collapsed" id="playerWrap">
        <div class="player-bar">
            <div class="left"><strong>Now Playing:</strong> <span id="npTitle">{{ item.title }}</span></div>
            <div class="right">
                {% if files|length > 1 %}
                <select id="sourceSelect" class="select">
                    {% for f in files %}
                    <option value="{{ f.id }}" data-file-id="{{ f.id }}">{{ f.path.split('/')[-1].split('\\')[-1] }}
                    </option>
                    {% endfor %}
                </select>
                {% endif %}
                <button id="minBtn" class="btn small" title="Minimize">–</button>
                <button id="closeBtn" class="btn small" title="Close">✕</button>
            </div>
        </div>
        <div class="player-area">
            <!-- Plyr-target video -->
            <video id="plyr" playsinline controls preload="metadata" poster="{{ poster }}"
                data-file-id="{{ files[0].id }}" data-item-id="{{ item.id }}" data-title="{{ item.title|e }}"></video>
        </div>
    </section>
    {% endif %}
</div>

<!-- Plyr assets (CSP in main.py already allows cdn.plyr.io) -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js" nonce="{{ request.state.csp_nonce }}"></script>

<!-- Our controller (loads hls.min.js on demand) -->
<script src="/static/js/player.js?v={{ ASSET_V }}" nonce="{{ request.state.csp_nonce }}"></script>

<style>
    .movie-detail .hero {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 22px;
        padding: 20px;
        border-radius: 16px;
        background: linear-gradient(to bottom, rgba(0, 0, 0, .45), rgba(0, 0, 0, .65)), var(--bg) center/cover no-repeat
    }

    .movie-detail .poster img {
        width: 220px;
        border-radius: 12px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, .4)
    }

    .movie-detail .title {
        font-size: 28px;
        margin: 0 0 6px
    }

    .movie-detail .year,
    .movie-detail .tagline,
    .movie-detail .genres {
        color: var(--muted)
    }

    .player-wrap {
        margin: 18px 0;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 14px;
        overflow: hidden;
        background: #0e0e0f;
        display: none
    }

    .player-wrap.expanded,
    .player-wrap.mini {
        display: block
    }

    .player-bar {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        padding: 8px 10px;
        background: #141418;
        border-bottom: 1px solid rgba(255, 255, 255, .06)
    }

    .player-area {
        padding: 10px
    }

    .player-area video {
        width: 100%;
        border-radius: 10px;
        background: #000
    }

    .player-wrap.mini {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 360px;
        max-width: 45vw;
        z-index: 50;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .5)
    }

    .player-wrap.mini .player-area video {
        height: 200px;
        object-fit: cover
    }

    .player-wrap.collapsed {
        display: none
    }

    .select {
        background: #18181d;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, .1);
        border-radius: 8px;
        padding: 6px 8px
    }

    .btn.small {
        padding: 4px 8px;
        font-size: 12px
    }

    .btn.primary {
        background: var(--primary);
        color: #fff
    }
</style>
{% endblock %}
