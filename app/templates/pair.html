<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pair Device â€¢ Arctic Media</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <style>
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .pair-box { max-width: 400px; padding: 24px; text-align: center; }
        .code-input { font-size: 24px; font-family: monospace; letter-spacing: 4px; text-align: center; text-transform: uppercase; }
        .hint { color: #999; margin-top: 16px; }
    </style>
</head>
<body>
    <div class="pair-box">
        <h1>Pair Roku Device</h1>
        <p>Enter the code shown on your Roku TV:</p>
        <div id="login-prompt" style="display: none; padding: 16px; background: #fee; border: 1px solid #faa; border-radius: 4px; margin: 16px 0;">
            <p style="margin: 0 0 12px 0; color: #c00;">You must be logged in to authorize devices.</p>
            <a href="/login?return_url=/pair" class="btn btn-primary">Go to Login</a>
        </div>
        <div id="server-info" style="margin: 16px 0; padding: 12px; background: #f5f5f5; border-radius: 4px; font-size: 14px;">
            <strong>Server:</strong> <span id="server-url-display">{{ server_url }}</span>
        </div>
        <form id="pair-form" style="margin-top: 24px; display: block;">
            <input type="text" id="code" class="input code-input" placeholder="ABCD-1234" maxlength="9" pattern="[A-Z]{4}-[0-9]{4}" required>
            <button type="submit" id="auth-button" class="btn btn-primary" style="margin-top: 16px; width: 100%;">Authorize</button>
        </form>
        <p id="msg" class="hint"></p>
    </div>
    <script nonce="{{ request.state.csp_nonce }}">
        console.log('Pair page loaded');
        
        const form = document.getElementById('pair-form');
        const codeInp = document.getElementById('code');
        const msg = document.getElementById('msg');
        const loginPrompt = document.getElementById('login-prompt');
        
        // Check if user is logged in
        fetch('/auth/me', { credentials: 'same-origin' })
            .then(r => {
                console.log('Auth check response:', r.status);
                if (r.ok) {
                    return r.json();
                } else {
                    throw new Error('Not logged in');
                }
            })
            .then((user) => {
                console.log('User is logged in:', user.username);
                // User is logged in, hide prompt and show form
                loginPrompt.style.display = 'none';
                form.style.display = 'block';
            })
            .catch((err) => {
                console.log('User not logged in:', err);
                // User not logged in, show prompt and hide form
                loginPrompt.style.display = 'block';
                form.style.display = 'none';
                msg.textContent = 'You must be logged in to authorize devices.';
                msg.style.color = '#f00';
            });
        
        codeInp.addEventListener('input', (e) => {
            let v = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            if (v.length >= 4 && !v.includes('-')) {
                v = v.slice(0, 4) + '-' + v.slice(4);
            }
            e.target.value = v.slice(0, 9);
        });

        // Make sure form exists before adding listener
        if (!form) {
            console.error('Form element not found!');
            msg.textContent = 'Error: Form not found. Please refresh the page.';
            msg.style.color = '#f00';
        } else {
            console.log('Form found, adding submit listener');
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('=== FORM SUBMITTED ===');
            const code = codeInp.value.trim().toUpperCase();
            console.log('Code entered:', code);
            if (!/^[A-Z]{4}-[0-9]{4}$/.test(code)) {
                msg.textContent = 'Invalid code format (use ABCD-1234)';
                msg.style.color = '#f00';
                return;
            }
            msg.textContent = 'Authorizing...';
            msg.style.color = '#999';
            const button = document.getElementById('auth-button') || form.querySelector('button');
            if (!button) {
                console.error('Button not found!');
                msg.textContent = 'Error: Submit button not found.';
                msg.style.color = '#f00';
                return;
            }
            button.disabled = true;
            button.textContent = 'Authorizing...';
            
            try {
                console.log('Sending request to /pair/activate with code:', code);
                const r = await fetch('/pair/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ user_code: code }),
                });
                console.log('Response status:', r.status, r.statusText);
                console.log('Response headers:', Object.fromEntries(r.headers.entries()));
                
                let data = {};
                try {
                    const text = await r.text();
                    console.log('Response text:', text);
                    if (text) {
                        data = JSON.parse(text);
                    }
                } catch (parseErr) {
                    console.error('Failed to parse JSON:', parseErr);
                    data = { detail: 'Failed to parse response' };
                }
                
                if (r.ok) {
                    msg.textContent = 'Device authorized! You can close this page.';
                    msg.style.color = '#0a0';
                    codeInp.disabled = true;
                    button.disabled = true;
                    button.textContent = 'Authorized';
                } else {
                    msg.style.color = '#f00';
                    if (r.status === 401) {
                        msg.textContent = 'You must be logged in. Please log in first, then try again.';
                    } else if (r.status === 404) {
                        msg.textContent = 'Invalid code. Please check the code and try again.';
                    } else if (r.status === 400) {
                        msg.textContent = data.detail || 'Invalid request. Code may be expired or already used.';
                    } else {
                        msg.textContent = data.detail || `Authorization failed (${r.status})`;
                    }
                    console.error('Activation error:', r.status, data);
                    button.disabled = false;
                    button.textContent = 'Authorize';
                }
            } catch (err) {
                msg.style.color = '#f00';
                msg.textContent = 'Network error: ' + (err.message || 'Unknown error');
                console.error('Network error:', err);
                button.disabled = false;
                button.textContent = 'Authorize';
            }
        });
    </script>
</body>
</html>

