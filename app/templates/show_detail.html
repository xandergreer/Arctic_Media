{% extends "base.html" %}
{% block title %}{{ item.title }} – Arctic{% endblock %}

{% block content %}
{% set ej = item.extra_json or {} %}
{% set poster = ej.get('poster') or item.poster_url or '/static/img/placeholder.png' %}
{% set backdrop = ej.get('backdrop') or item.backdrop_url or '' %}

<div class="page show-detail">
    <div class="hero" style="--bg:url('{{ backdrop }}')">
        <div class="poster"><img src="{{ poster }}" alt="{{ item.title }}"></div>
        <div class="meta">
            <h1 class="title">{{ item.title }}</h1>
            <div class="tagline muted">{% if item.year %}{{ item.year }} · {% endif %}TV Series</div>
            {% if ej.get('overview') %}<p class="hero-overview">{{ ej['overview'] }}</p>{% endif %}
            <div class="actions">
                {% if first_play_file_id %}
                <button id="playBtn" class="btn primary" data-file-id="{{ first_play_file_id }}"
                    data-item-id="{{ item.id }}" data-title="{{ item.title|e }}">▶ Play</button>
                {% endif %}
                {% if user and user.is_admin %}
                <button id="editShowBtn" class="btn" title="Edit metadata" style="display:inline-flex;align-items:center;gap:6px;">
                    <span aria-hidden="true">✎</span> Edit
                </button>
                {% endif %}
                <a class="btn" href="/tv">Back to TV</a>
            </div>
        </div>
    </div>

    <!-- Player -->
    <section class="player-wrap collapsed" id="playerWrap">
        <div class="player-bar">
            <div class="left"><strong>Now Playing:</strong> <span id="npTitle">{{ item.title }}</span></div>
            <div class="right">
                {% if files|length > 1 %}
                <select id="sourceSelect" class="select">
                    {% for f in files %}
                    <option value="{{ f.id }}" data-file-id="{{ f.id }}">{{ f.path.split('/')[-1].split('\\')[-1] }}
                    </option>
                    {% endfor %}
                </select>
                {% endif %}
                <button id="minBtn" class="btn small" title="Minimize">–</button>
                <button id="closeBtn" class="btn small" title="Close">✕</button>
            </div>
        </div>
        <div class="player-area">
            <video id="plyr" playsinline controls preload="metadata" poster="{{ poster }}" {% if first_play_file_id
                %}data-file-id="{{ first_play_file_id }}" data-item-id="{{ item.id }}" data-title="{{ item.title|e }}"
                {% endif %}></video>
        </div>
    </section>

    {% if seasons|length %}
    <h2>Seasons</h2>
    <div class="grid">
        {% for season in seasons %}
        {% set sej = season.extra_json or {} %}
        {% set sposter = sej.get('poster') or season.poster_url or poster %}
        <a class="card" href="/show/{{ item.id }}/season/{{ loop.index }}">
            <img loading="lazy" src="{{ sposter }}" alt="{{ season.title }}">
            <div class="card-meta">
                <div class="title">{{ season.title }}</div>
                {% if sej.get('air_date') %}<div class="sub">{{ sej['air_date'][:4] }}</div>{% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    {% if episodes|length %}
    <h2>Episodes</h2>
    <div class="grid">
        {% for ep in episodes %}
        {% set eej = ep.extra_json or {} %}
        {% set still = eej.get('still') or ep.poster_url or poster %}
        <button class="card ep-card" type="button" data-file-id="{{ ep.first_file_id }}" data-title="{{ ep.title|e }}" style="position:relative;">
            <img loading="lazy" src="{{ still }}" alt="{{ ep.title }}">
            <div class="card-meta">
                <div class="title">{{ "%02d" % (eej.get('episode') or loop.index) }} · {{ ep.title }}</div>
                {% if eej.get('air_date') %}<div class="sub">{{ eej['air_date'] }}</div>{% endif %}
            </div>
            {% if user and user.is_admin %}
            <button class="btn small ep-edit" type="button" title="Edit episode" style="position:absolute;right:8px;top:8px;">✎</button>
            <input type="hidden" class="ep-id" value="{{ ep.id }}">
            {% endif %}
        </button>
        {% endfor %}
    </div>
    {% endif %}
</div>

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js" nonce="{{ request.state.csp_nonce }}"></script>
<script src="/static/js/player.js?v={{ ASSET_V }}" nonce="{{ request.state.csp_nonce }}"></script>

<style>
    .show-detail .hero {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 22px;
        padding: 20px;
        border-radius: 16px;
        background: linear-gradient(to bottom, rgba(0, 0, 0, .45), rgba(0, 0, 0, .65)), var(--bg) center/cover no-repeat
    }

    .show-detail .poster img {
        width: 220px;
        border-radius: 12px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, .4)
    }

    .show-detail .title {
        font-size: 28px;
        margin: 0 0 6px
    }

    .player-wrap {
        margin: 18px 0;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 14px;
        background: #0e0e0f;
        display: none
    }

    .player-wrap.expanded,
    .player-wrap.mini {
        display: block
    }

    .player-bar {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        padding: 8px 10px;
        background: #141418;
        border-bottom: 1px solid rgba(255, 255, 255, .06)
    }

    .player-area {
        padding: 10px
    }

    .player-area video {
        width: 100%;
        border-radius: 10px;
        background: #000
    }

    .player-wrap.mini {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 360px;
        max-width: 45vw;
        z-index: 50;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .5)
    }

    .player-wrap.mini .player-area video {
        height: 200px;
        object-fit: cover
    }

    .player-wrap.collapsed {
        display: none
    }

    .card.ep-card {
        display: block;
        text-align: left
    }

    .btn.primary {
        background: var(--primary);
        color: #fff
    }
</style>
{% if user and user.is_admin %}
<div id="editShowModal" class="modal hidden">
  <div class="modal-card" style="max-width:720px;width:100%">
    <header class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Edit Show</h3>
      <button id="showClose" class="btn btn-ghost">Close</button>
    </header>
    <div class="modal-body" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <label>Title
        <input id="s-title" class="input" type="text" value="{{ item.title|e }}">
      </label>
      <label>TMDB ID
        <input id="s-tmdb" class="input" type="number" value="{{ (ej.get('tmdb_id') if ej else '') }}" placeholder="e.g. 1399">
      </label>
      <label style="grid-column:1/-1;">Poster URL
        <input id="s-poster" class="input" type="text" value="{{ poster }}">
      </label>
      <label style="grid-column:1/-1;">Backdrop URL
        <input id="s-backdrop" class="input" type="text" value="{{ backdrop }}">
      </label>
      <label style="grid-column:1/-1;display:flex;align-items:center;gap:8px;">
        <input id="s-refresh" type="checkbox"> <span>Refresh from TMDB (uses TMDB ID if provided, otherwise searches by title)</span>
      </label>
    </div>
    <footer class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
      <button id="s-save" class="btn btn-primary">Save</button>
    </footer>
  </div>
  <div id="showBackdrop" class="modal-backdrop"></div>
  <style>
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100}
    .modal-card{position:relative;z-index:2;background:#151515;border:1px solid #333;border-radius:10px;padding:14px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1}
  </style>
  <script nonce="{{ request.state.csp_nonce }}">
    (function(){
      const $=(s)=>document.querySelector(s);
      const open=()=>$('#editShowModal')?.classList.remove('hidden');
      const close=()=>$('#editShowModal')?.classList.add('hidden');
      $('#editShowBtn')?.addEventListener('click', open);
      $('#showClose')?.addEventListener('click', close);
      $('#showBackdrop')?.addEventListener('click', close);
      $('#s-save')?.addEventListener('click', async ()=>{
        const body={
          title: ($('#s-title')?.value||'').trim()||null,
          tmdb_id: (parseInt($('#s-tmdb')?.value)||null),
          poster_url: ($('#s-poster')?.value||'').trim()||null,
          backdrop_url: ($('#s-backdrop')?.value||'').trim()||null,
          refresh_from_tmdb: !!$('#s-refresh')?.checked,
        };
        try{ const r=await fetch(`/admin/media/{{ item.id }}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
          if(!r.ok){ alert('Save failed'); return }
          location.reload();
        }catch(e){ alert('Save failed: '+e.message) }
      });
    })();
  </script>
</div>

<div id="editEpModal" class="modal hidden">
  <div class="modal-card" style="max-width:680px;width:100%">
    <header class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Edit Episode</h3>
      <button id="epClose" class="btn btn-ghost">Close</button>
    </header>
    <div class="modal-body" style="display:grid;grid-template-columns:1fr;gap:12px;">
      <input type="hidden" id="ep-id" value="">
      <label>Title
        <input id="e-title" class="input" type="text" value="">
      </label>
      <label>Still URL
        <input id="e-still" class="input" type="text" value="">
      </label>
      <label style="display:flex;align-items:center;gap:8px;">
        <input id="e-refresh" type="checkbox"> <span>Refresh from TMDB (requires show TMDB + season/episode numbers present)</span>
      </label>
    </div>
    <footer class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
      <button id="e-save" class="btn btn-primary">Save</button>
    </footer>
  </div>
  <div id="epBackdrop" class="modal-backdrop"></div>
  <style>
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100}
    .modal-card{position:relative;z-index:2;background:#151515;border:1px solid #333;border-radius:10px;padding:14px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1}
  </style>
  <script nonce="{{ request.state.csp_nonce }}">
    (function(){
      const qsa=(s)=>Array.from(document.querySelectorAll(s));
      const $=(s)=>document.querySelector(s);
      function open(){ $('#editEpModal')?.classList.remove('hidden'); }
      function close(){ $('#editEpModal')?.classList.add('hidden'); }
      $('#epClose')?.addEventListener('click', close);
      $('#epBackdrop')?.addEventListener('click', close);
      qsa('.ep-edit').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          ev.stopPropagation(); ev.preventDefault();
          const card = btn.closest('.ep-card');
          const id = card.querySelector('.ep-id')?.value || '';
          const title = card.getAttribute('data-title') || card.querySelector('.title')?.textContent || '';
          const img = card.querySelector('img')?.getAttribute('src') || '';
          $('#ep-id').value = id;
          $('#e-title').value = title;
          $('#e-still').value = img;
          open();
        });
      });
      $('#e-save')?.addEventListener('click', async ()=>{
        const id = $('#ep-id').value;
        if(!id) return close();
        const body={
          title: ($('#e-title')?.value||'').trim()||null,
          poster_url: ($('#e-still')?.value||'').trim()||null,
          refresh_from_tmdb: !!$('#e-refresh')?.checked,
        };
        try{ const r=await fetch(`/admin/media/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
          if(!r.ok){ alert('Save failed'); return }
          location.reload();
        }catch(e){ alert('Save failed: '+e.message) }
      });
    })();
  </script>
</div>
{% endif %}
{% endblock %}
